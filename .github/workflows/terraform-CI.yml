name: terraform-ci
on:
  pull_request:
    branches: [ main ]

env:
  TF_VERSION: 1.5.0

jobs:
  lint-validate-scan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with: terraform_version: ${{ env.TF_VERSION }}

      - name: Install tools
        run: |
          sudo apt-get update -y
          pip install checkov
          curl -sLo tfsec https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec-linux-amd64
          chmod +x tfsec && sudo mv tfsec /usr/local/bin/
          curl -sSL https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Terraform fmt (check)
        run: terraform fmt -check

      - name: Terraform init
        run: terraform init -input=false

      - name: Terraform validate (json)
        run: terraform validate -json > validate.json || true
      - name: Show validation
        run: cat validate.json

      - name: TFLint
        run: tflint --init && tflint

      - name: tfsec
        run: tfsec .

      - name: Checkov
        run: checkov -d .

      - name: Terraform plan
        run: terraform plan -out=plan.tfplan -input=false

      - name: Terraform show plan JSON
        run: terraform show -json plan.tfplan > plan.json

      - name: Conftest (OPA) policy checks
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_0.37.0_Linux_x86_64.tar.gz
          tar -xzf conftest_0.37.0_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          conftest test plan.json --policy policy || true

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: plan.tfplan
